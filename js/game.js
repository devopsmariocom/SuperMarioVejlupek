class Game{constructor(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.baseWidth=800,this.baseHeight=600,this.aspectRatio=this.baseWidth/this.baseHeight,this.resizeCanvas(),this.isRunning=!1,this.gameOver=!1,this.gameWon=!1,this.level=1,this.scale=1,this.cameraX=0,this.levelLength=5*this.baseWidth,this.player=new Player(50,this.baseHeight/2),this.platforms=[],this.enemies=[],this.coins=[],this.mysteryBoxes=[],this.boss=null,this.activeEffectMessage=null,this.effectMessageTimer=0,Input.init(),window.addEventListener("resize",(()=>this.resizeCanvas())),document.getElementById("fullscreenButton").addEventListener("click",(()=>this.toggleFullscreen()))}resizeCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.width=this.canvas.width,this.height=this.canvas.height,this.scale=Math.min(this.width/this.baseWidth,this.height/this.baseHeight),this.isRunning&&this.adjustGameObjects()}adjustGameObjects(){this.loadLevel()}toggleFullscreen(){console.log("Toggling fullscreen mode");const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),e=/iPad|iPhone|iPod/.test(navigator.userAgent);try{if(t)if(console.log("Mobile device detected"),e){console.log("iOS device detected");const t=document.body;t.classList.contains("ios-fullscreen")?(console.log("Exiting iOS fullscreen mode"),t.classList.remove("ios-fullscreen")):(console.log("Entering iOS fullscreen mode"),t.classList.add("ios-fullscreen"),setTimeout((()=>{window.scrollTo(0,1)}),100),screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").catch((t=>{console.log("Orientation lock failed: ",t)})))}else console.log("Android or other mobile device detected"),document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?(console.log("Exiting fullscreen mode on Android"),document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),document.body.classList.remove("mobile-fullscreen")):(console.log("Entering fullscreen mode on Android"),(async()=>{try{this.canvas.requestFullscreen?await this.canvas.requestFullscreen():this.canvas.webkitRequestFullscreen?await this.canvas.webkitRequestFullscreen():this.canvas.mozRequestFullScreen?await this.canvas.mozRequestFullScreen():this.canvas.msRequestFullscreen?await this.canvas.msRequestFullscreen():document.documentElement.requestFullscreen?await document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen?await document.documentElement.webkitRequestFullscreen():document.documentElement.mozRequestFullScreen?await document.documentElement.mozRequestFullScreen():document.documentElement.msRequestFullscreen&&await document.documentElement.msRequestFullscreen(),screen.orientation&&screen.orientation.lock&&await screen.orientation.lock("landscape").catch((t=>{console.log("Orientation lock failed: ",t)}))}catch(t){console.error("Error attempting to enter fullscreen:",t),document.body.classList.add("mobile-fullscreen"),setTimeout((()=>{window.scrollTo(0,1)}),100)}})());else console.log("Desktop browser detected"),document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?(console.log("Exiting fullscreen mode on desktop"),document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()):(console.log("Entering fullscreen mode on desktop"),document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.msRequestFullscreen&&document.documentElement.msRequestFullscreen())}catch(t){console.error("Fullscreen toggle error:",t)}setTimeout((()=>{this.resizeCanvas(),this.isRunning&&this.adjustGameObjects()}),t?500:200)}start(){this.isRunning||(this.isRunning=!0,this.gameOver=!1,this.gameWon=!1,this.level=1,this.cameraX=0,this.player=new Player(50,this.baseHeight/2),this.loadLevel(),this.gameLoop())}loadLevel(){this.cameraX=0,this.platforms=LevelGenerator.generateLevel(this.width,this.height),this.enemies=EnemyGenerator.generateEnemies(this.platforms,this.level+2),this.mysteryBoxes=MysteryBoxGenerator.generateMysteryBoxes(this.platforms,10+2*this.level),console.log("Generated mystery boxes:",this.mysteryBoxes.length);const t=this.levelLength-250,e=this.baseHeight-150-100;this.boss=new Boss(t,e),this.activeEffectMessage=null,this.effectMessageTimer=0}gameLoop(){this.isRunning&&(this.ctx.clearRect(0,0,this.width,this.height),this.update(),this.draw(),this.player.lives<=0&&(this.gameOver=!0,this.isRunning=!1,this.drawGameOver()),this.gameWon&&(this.isRunning=!1,this.drawWinScreen()),requestAnimationFrame((()=>this.gameLoop())))}update(){this.player.update(Input,this.platforms);const t=this.levelLength-this.player.width;this.player.x>t&&(this.player.x=t);const e=.3*this.baseWidth;this.player.x>this.cameraX+this.baseWidth-e&&(this.cameraX=this.player.x-(this.baseWidth-e)),this.cameraX=Math.max(0,Math.min(this.cameraX,this.levelLength-this.baseWidth));for(let t of this.mysteryBoxes)if(Math.abs(t.x-this.cameraX)<1.5*this.baseWidth&&(t.update(),t.checkCollision(this.player))){const e=t.activate(this.player);this.activeEffectMessage=e,this.effectMessageTimer=180,this.player.score+=50}for(let t of this.enemies)Math.abs(t.x-this.cameraX)<1.5*this.baseWidth&&(t.update(this.platforms),t.checkCollision(this.player)&&(this.player.velocityY>0&&this.player.y+this.player.height<t.y+t.height/2?(this.enemies.splice(this.enemies.indexOf(t),1),this.player.velocityY=-this.player.jumpForce/2,this.player.score+=100):this.player.isInvincible||(this.player.lives--,this.player.lives>0&&(this.player.x=this.cameraX+100,this.player.y=this.baseHeight/2,this.player.velocityY=0))));this.boss&&(this.boss.update(this.player),this.boss.checkBananaCollisions(this.player)&&!this.player.isInvincible&&(this.player.lives--,this.player.lives<=0&&(this.gameOver=!0,this.isRunning=!1)),this.boss.checkPlayerAttack(this.player)&&(this.player.velocityY=-this.player.jumpForce,this.player.score+=200,this.boss.health<=0&&(this.gameWon=!0,this.player.score+=1e3))),this.player.y>this.baseHeight+100&&(this.player.isInvincible||this.player.lives--,this.player.lives>0?(this.player.x=this.cameraX+100,this.player.y=this.baseHeight/2,this.player.velocityY=0):(this.gameOver=!0,this.isRunning=!1)),this.effectMessageTimer>0&&(this.effectMessageTimer--,0===this.effectMessageTimer&&(this.activeEffectMessage=null)),Input.keys.upPressed=!1}draw(){this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.save(),this.ctx.scale(this.scale,this.scale);const t=(this.width/this.scale-this.baseWidth)/2,e=(this.height/this.scale-this.baseHeight)/2;this.ctx.translate(t,e);const i=this.cameraX;this.drawBackground(i);for(let t of this.platforms)t.x+t.width>i-100&&t.x<i+this.baseWidth+100&&t.draw(this.ctx,i);for(let t of this.mysteryBoxes)!t.isCollected&&t.x+t.width>i-50&&t.x<i+this.baseWidth+50&&t.draw(this.ctx,i);for(let t of this.enemies)t.x+t.width>i-50&&t.x<i+this.baseWidth+50&&t.draw(this.ctx,i);this.boss&&this.boss.draw(this.ctx,i),this.player.draw(this.ctx,i),this.ctx.restore(),this.drawUI(),this.activeEffectMessage&&this.effectMessageTimer>0&&this.drawEffectMessage(),this.gameWon&&this.drawWinScreen()}drawBackground(t){this.ctx.fillStyle="rgba(255, 255, 255, 0.7)";const e=[{x:100,y:100,width:120,height:60},{x:500,y:150,width:150,height:70},{x:900,y:80,width:100,height:50},{x:1300,y:120,width:130,height:65},{x:1700,y:90,width:110,height:55},{x:2100,y:130,width:140,height:70},{x:2500,y:100,width:120,height:60},{x:2900,y:140,width:130,height:65},{x:3300,y:110,width:110,height:55},{x:3700,y:80,width:140,height:70}];for(let i of e){const e=.7*t,s=i.x-e;s+i.width>0&&s<this.baseWidth&&(this.ctx.beginPath(),this.ctx.arc(s+.3*i.width,i.y+.5*i.height,.5*i.height,0,2*Math.PI),this.ctx.arc(s+.7*i.width,i.y+.5*i.height,.6*i.height,0,2*Math.PI),this.ctx.arc(s+.5*i.width,i.y+.4*i.height,.7*i.height,0,2*Math.PI),this.ctx.fill())}this.ctx.fillStyle="rgba(100, 100, 150, 0.5)";const i=[{x:0,width:500,height:200},{x:400,width:600,height:250},{x:1e3,width:450,height:180},{x:1500,width:550,height:220},{x:2100,width:500,height:200},{x:2700,width:600,height:250},{x:3300,width:450,height:180},{x:3800,width:550,height:220}];for(let e of i){const i=.4*t,s=e.x-i;s+e.width>0&&s<this.baseWidth&&(this.ctx.beginPath(),this.ctx.moveTo(s,this.baseHeight),this.ctx.lineTo(s+e.width/2,this.baseHeight-e.height),this.ctx.lineTo(s+e.width,this.baseHeight),this.ctx.fill())}}drawUI(){this.ctx.fillStyle="#000000";const t=Math.max(16,Math.floor(20*this.scale));this.ctx.font=`${t}px Arial`;const e=Math.max(30,Math.floor(40*this.scale));this.ctx.fillText(`Score: ${this.player.score}`,e,e+t),this.ctx.fillText(`Lives: ${this.player.lives}`,e,2*e+2*t);const i=Math.max(100,Math.floor(200*this.scale)),s=Math.max(10,Math.floor(15*this.scale)),h=this.width-e-i,l=e;this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(h,l,i,s);const c=Math.min(1,this.cameraX/(this.levelLength-this.baseWidth));if(this.ctx.fillStyle="#00FF00",this.ctx.fillRect(h,l,i*c,s),this.boss&&(this.ctx.fillStyle="#FF0000",this.ctx.fillRect(h+i-s,l,s,s)),this.boss&&this.boss.active){const i=Math.max(150,Math.floor(250*this.scale)),s=Math.max(15,Math.floor(20*this.scale)),h=(this.width-i)/2,l=e;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(h,l,i,s),this.ctx.fillStyle="#FF0000",this.ctx.fillRect(h,l,i*(this.boss.health/5),s),this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="center",this.ctx.fillText("BOSS",this.width/2,l+s+t),this.ctx.textAlign="left"}}drawEffectMessage(){if(!this.activeEffectMessage)return;const t=this.activeEffectMessage;let e=1;this.effectMessageTimer>150?e=(180-this.effectMessageTimer)/30:this.effectMessageTimer<30&&(e=this.effectMessageTimer/30),this.ctx.save();const i=Math.max(250,Math.floor(300*this.scale)),s=Math.max(70,Math.floor(80*this.scale)),h=(this.width-i)/2,l=Math.max(80,Math.floor(100*this.scale));let c,a;["poop","glitch","reverse","shrink"].includes(t.type)?(c=`rgba(255, 0, 0, ${.7*e})`,a="#FFFFFF"):(c=`rgba(0, 128, 0, ${.7*e})`,a="#FFFFFF"),this.ctx.fillStyle=c,this.ctx.strokeStyle=`rgba(255, 255, 255, ${e})`,this.ctx.lineWidth=2,this.ctx.beginPath();const n=10;this.ctx.moveTo(h+n,l),this.ctx.lineTo(h+i-n,l),this.ctx.arcTo(h+i,l,h+i,l+n,n),this.ctx.lineTo(h+i,l+s-n),this.ctx.arcTo(h+i,l+s,h+i-n,l+s,n),this.ctx.lineTo(h+n,l+s),this.ctx.arcTo(h,l+s,h,l+s-n,n),this.ctx.lineTo(h,l+n),this.ctx.arcTo(h,l,h+n,l,n),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=a;const o=Math.max(20,Math.floor(24*this.scale)),r=Math.max(16,Math.floor(18*this.scale));this.ctx.font=`bold ${o}px Arial`,this.ctx.textAlign="center",this.ctx.fillText(t.name,this.width/2,l+o+5),this.ctx.font=`${r}px Arial`,this.ctx.fillText(t.description,this.width/2,l+o+r+10),this.ctx.restore()}drawGameOver(){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="center";const t=Math.max(32,Math.floor(48*this.scale)),e=Math.max(18,Math.floor(24*this.scale));this.ctx.font=`${t}px Arial`,this.ctx.fillText("GAME OVER",this.width/2,this.height/2-t),this.ctx.font=`${e}px Arial`,this.ctx.fillText(`Final Score: ${this.player.score}`,this.width/2,this.height/2+e);const i=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),s=this.height/2+3*e;if(i){const t="TAP HERE TO PLAY AGAIN",i=this.ctx.measureText(t).width,h=1.2*e;this.ctx.fillStyle="rgba(255, 87, 34, 0.8)",this.ctx.fillRect(this.width/2-i/2-h,s-e-h/2,i+2*h,e+h),this.ctx.fillStyle="white",this.ctx.fillText(t,this.width/2,s),this.restartButtonArea={x:this.width/2-i/2-h,y:s-e-h/2,width:i+2*h,height:e+h}}else this.ctx.fillStyle="#FFFFFF",this.ctx.fillText("Press SPACE to play again",this.width/2,s);const h=t=>{" "!==t.key&&"Space"!==t.code||(window.removeEventListener("keydown",h),this.canvas.removeEventListener("touchstart",l),this.start())},l=t=>{t.preventDefault();const e=t.touches[0],i=e.clientX,s=e.clientY;if(this.restartButtonArea){const t=this.restartButtonArea;i>=t.x&&i<=t.x+t.width&&s>=t.y&&s<=t.y+t.height&&(window.removeEventListener("keydown",h),this.canvas.removeEventListener("touchstart",l),this.start())}};window.addEventListener("keydown",h),this.canvas.addEventListener("touchstart",l,{passive:!1})}drawWinScreen(){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="#FFD700",this.ctx.textAlign="center";const t=Math.max(32,Math.floor(48*this.scale)),e=Math.max(18,Math.floor(24*this.scale));this.ctx.font=`${t}px Arial`,this.ctx.fillText("YOU WIN!",this.width/2,this.height/2-t),this.ctx.font=`${e}px Arial`,this.ctx.fillText(`Final Score: ${this.player.score}`,this.width/2,this.height/2+e),this.ctx.fillText("You defeated the Banana Boss!",this.width/2,this.height/2+2*e);const i=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),s=this.height/2+4*e;if(i){const t="TAP HERE TO PLAY AGAIN",i=this.ctx.measureText(t).width,h=1.2*e;this.ctx.fillStyle="rgba(255, 215, 0, 0.8)",this.ctx.fillRect(this.width/2-i/2-h,s-e-h/2,i+2*h,e+h),this.ctx.fillStyle="black",this.ctx.fillText(t,this.width/2,s),this.winRestartButtonArea={x:this.width/2-i/2-h,y:s-e-h/2,width:i+2*h,height:e+h}}else this.ctx.fillStyle="#FFD700",this.ctx.fillText("Press SPACE to play again",this.width/2,s);const h=Math.max(50,Math.floor(80*this.scale));this.ctx.fillStyle="#FFD700",this.ctx.beginPath(),this.ctx.moveTo(this.width/2-h,this.height/2-2*t),this.ctx.lineTo(this.width/2-h/2,this.height/2-3*t),this.ctx.lineTo(this.width/2,this.height/2-2*t),this.ctx.lineTo(this.width/2+h/2,this.height/2-3*t),this.ctx.lineTo(this.width/2+h,this.height/2-2*t),this.ctx.fill();const l=t=>{" "!==t.key&&"Space"!==t.code||(window.removeEventListener("keydown",l),this.canvas.removeEventListener("touchstart",c),this.start())},c=t=>{t.preventDefault();const e=t.touches[0],i=e.clientX,s=e.clientY;if(this.winRestartButtonArea){const t=this.winRestartButtonArea;i>=t.x&&i<=t.x+t.width&&s>=t.y&&s<=t.y+t.height&&(window.removeEventListener("keydown",l),this.canvas.removeEventListener("touchstart",c),this.start())}};window.addEventListener("keydown",l),this.canvas.addEventListener("touchstart",c,{passive:!1})}}